<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en">
<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <title>COVID Vaccinations</title>
    <link rel="icon" href=vax.png">
</head>
<style>

    body {
        font-family: Helvetica;
        color: aliceblue;
    }
    h1,h3 {
        font-weight: lighter;
    }

    .line {
        fill: none;
        stroke-width: 4px;
    }
</style>



<body style="background-color:darkslategray">
<h1>US Vaccination Progress: Total</h1>
<h3>Hover over a line to see exact count.</h3>
<div class="flexbox-container" style="display:flex;">
    <div class="main" style="flex:1; width: 1000px; height: 100%;">
        <div id="chart1" style="width:1200px"></div>
        <div style="height: 70px"></div>
        <h1>US Vaccination Progress: Distribution by Age</h1>
        <div id="chart2" style="width:1200px"></div>
    </div>
    <div class="sidebar" id="my-sidebar" style="flex:1; width: 400px; height: 100%;">
        <img src="vax.png" height="450px">
    </div>
</div>
<script>
    const margin = {top: 200, right: 20, bottom: 30, left: 110},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // svg to contain chart
    var svg = d3.select('#chart1').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            `translate(${margin.left}, ${margin.top})`);

    var svg2 = d3.select('#chart2').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom+100)
        .append("g")
        .attr("transform",
            `translate(${margin.left}, ${margin.top})`);

    var parseTime = d3.timeParse("%m/%d/%y");

    d3.csv("trends.csv").then((rawData) => {
        var data = rawData.filter(d => d["Program"] === "US").filter(d => d["Date Type"] === "Admin")
        data.forEach(function(d) {
            d.daily_full = +d["Daily Count of People Fully Vaccinated"];
            d.total_full = +d["People Fully Vaccinated Cumulative"];
            d.avg_full = +d["7-Day Avg Daily Count of People Fully Vaccinated"];
            d.date = parseTime(d["Date"]);
        });

        function graph() {
            var xScale = d3.scaleTime()
                .domain(d3.extent(data, d=>d.date))
                .range([0, width]).nice();
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat("%b %_d"))).style("font-size","18px");

            var yScale = d3.scaleLinear()
                .domain(d3.extent(data, d=>d.daily_full))
                .range([height, 0]);
            svg.append("g")
                .call(d3.axisLeft(yScale)).style("font-size","20px");

            var makeLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.daily_full))
                .defined(d => d.daily_full != 0).curve(d3.curveCardinal.tension(0));

            svg.append("path")
                .data([data])
                .attr("class", "line")
                .attr("stroke", "steelblue")
                .attr("d", makeLine)
                .on('mouseover', mouseover)
                .on('mousemove', mousemove)
                .on('mouseout', mouseout);

            var makeLine3 = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.avg_full))
                .defined(d => d.daily_full != 0).curve(d3.curveCardinal.tension(0));

            svg.append("path")
                .data([data])
                .attr("class", "line")
                .attr("stroke", "green")
                .attr("d", makeLine3)

            var bisect = d3.bisector(d => d.date).left;

            var focus = svg
                .append('g')
                .append('circle')
                .style("fill", "skyblue")
                .attr("stroke", "none")
                .attr('r', 8.5)
                .style("opacity", 0)

            var focusText = svg
                .append('g')
                .append('text')
                .style("opacity", 0)
                .style("font-size","20px")
                .attr('fill', 'white')
                .attr("text-anchor", "left")
                .attr("alignment-baseline", "middle");


            function mouseover() {
                focus.style("opacity", 1)
                focusText.style("opacity",1)
            }

            function mousemove(event) {
                // recover coordinate we need
                var x0 = xScale.invert(d3.pointer(event)[0]);
                var i = bisect(data, x0, 1);
                var selectedData = data[i];
                focus
                    .attr("cx", xScale(selectedData.date))
                    .attr("cy", yScale(selectedData.daily_full))
                focusText
                    .html("count:" + selectedData.daily_full)
                    .attr("x", xScale(selectedData.date)+15)
                    .attr("y", yScale(selectedData.daily_full))
            }
            function mouseout() {
                focus.style("opacity", 0)
                focusText.style("opacity", 0)
            }

            };
        graph();



    });


    d3.csv("demographics.csv").then((data) => {
        // var data = rawData.filter(d => d["Program"] === "US").filter(d => d["Date Type"] === "Admin")
        data.forEach(function(d) {
            d.doses = +d["People who are fully vaccinated"];
            d.single_dose = +d["People with at least one dose"];
            d.date = parseTime(d["Date"]);
            d.age = d["Age Group"];
        });

        data=data.filter(d=>d.age != "Age_known")
        data= data.filter(d=>d.age != "Age_unknown")
        var per_age_group = Array.from(d3.group(data, d => d.age), ([key,value]) =>({key, value}));
        var categories = ["Ages_65-74_yrs","Ages_50-64_yrs", "Ages_40-49_yrs", "Ages_30-39_yrs",
            "Ages_18-29_yrs", "Ages_<18yrs"];
        // console.log(categories);

        // Add X axis
        var xScale = d3.scaleTime()
            .domain(d3.extent(data, d=>d.date))
            .range([0, width]);
        svg2.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat("%b %_d"))).style("font-size","18px");

        var yScale = d3.scaleLinear()
            .domain(d3.extent(data, d=>d.doses))
            .range([height, 0]);
        // svg.append("g")
        //     .call(d3.axisLeft(yScale)).style("font-size","20px");
        var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
        var makeLine = d3.line()
            .x(d => xScale(d.date))
            .y(d => yScale(d.doses))
            .defined(d => d.doses != 0).curve(d3.curveCardinal.tension(0));

        // Create the Y axis for names
        var yName = d3.scaleBand()
            .domain(categories)
            .range([0, height])
            .paddingInner(1)
        svg2.append("g")
            .call(d3.axisLeft(yName)).style("font-size","20px");

        // Compute kernel density estimation for each column:
        // var kde = kernelDensityEstimator(kernelEpanechnikov(7), x.ticks(40)) // increase this 40 for more accurate density.
        // var allDensity = []
        // per_age_group.forEach(function(d,i) {
        //     svg2.append("path")
        //         .attr("class", "line")
        //         .attr("transform", function(d){return("translate(0," + (yName(d.key)-height) +")" )})
        //         .style("stroke", function() {
        //             return d.color = colorScale(d.key); })
        //         .attr("d", makeLine(d.value))
        // })


        // for (i = 0; i < n; i++) {
        //     key = categories[i]
        //     density = kde( data.map(function(d){  return d[key]; }) )
        //     allDensity.push({key: key, density: density})
        // }
        // Add areas
        svg2.selectAll("path")
            .data(per_age_group)
            .enter()
            .append("path")
            .attr("transform", function(d){return("translate(0," + (yName(d.key)-height) +")" )})
            .datum(function(d){return(d.value)})
            .attr("fill", "#69b3a2")
            .attr("stroke", "#000")
            .attr("stroke-width", 1)
            .attr("d",  makeLine)

    });
</script>
</body>
</html>